# Copyright (c) Microsoft Corporation.
# Licensed under the MIT license.

#=======================================================================================================================
# Project Directories
#=======================================================================================================================

export BINDIR ?= $(CURDIR)/bin

#=======================================================================================================================
# Toolchain Configuration
#=======================================================================================================================

# C
export CC := gcc
export CFLAGS := -std=c99 -D_POSIX_C_SOURCE=199309L
export CFLAGS += -O3

#=======================================================================================================================
# Build Artifacts
#=======================================================================================================================

# Source Files
SRC=main.c

# Executable File
EXEC=tlse.elf

#=======================================================================================================================

all:
	mkdir -p $(BINDIR)
	$(CC) $(CFLAGS) $(SRC) -o $(BINDIR)/$(EXEC) -DTLS_AMALGAMATION

run:
	sudo -E \
	$(ENV) \
	CONFIG_PATH=$(CONFIG_DIR)/node8_config.yaml \
	LD_LIBRARY_PATH=$(LD_LIBRARY_PATH) \
	LD_PRELOAD=$(LIBDIR)/libshim.so \
	$(BINDIR)/$(EXEC)

clean:
	rm -f $(BINDIR)/$(EXEC)
